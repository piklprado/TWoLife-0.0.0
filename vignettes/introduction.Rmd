---
title: "TWoLife SLOSS Simulation: Exploring Landscape Configuration and Genetic Effects"
author: "TWoLife Package"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    fig_width: 7
    fig_height: 5
vignette: >
  %\VignetteIndexEntry{TWoLife SLOSS Simulation: Exploring Landscape Configuration and Genetic Effects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

This vignette demonstrates the capabilities of the TWoLife package through two major analyses:

1. **SLOSS Debate**: Testing whether Single Large or Several Small habitat reserves better support populations
2. **Genetic Mechanisms**: Exploring how genetic variation, evolution, and behavior enable population persistence in heterogeneous environments

The SLOSS (Single Large Or Several Small) debate is a fundamental question in conservation biology concerning optimal reserve design. This vignette uses spatially explicit individual-based simulations to address this question while also exploring advanced genetic features.

# Setup

```{r library}
library(TWoLife)

# Single master seed for full reproducibility
MASTER_SEED <- 42
set.seed(MASTER_SEED)

# Helper functions for visual separators
print_separator <- function(char = "=", width = 80) {
  cat(paste(rep(char, width), collapse = ""), "\n")
}

print_subseparator <- function(char = "-", width = 80) {
  cat(paste(rep(char, width), collapse = ""), "\n")
}

# Banner
print_separator()
cat("                    TWoLife SLOSS SIMULATION                    \n")
cat("           Exploring Landscape Configuration Effects            \n")
print_separator()
cat("Master seed:", MASTER_SEED, "\n")
cat("Date:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
print_separator()
cat("\n")
```

# Part 1: SLOSS Analysis

## Background

The SLOSS debate asks: **Which is better for conservation?**

- **Single Large** reserve (SL)
- **Several Small** reserves with equivalent total area (SS)

We'll test this using three landscape configurations:

1. **Pristine** baseline (100% habitat coverage)
2. **Single Large** patch (one contiguous reserve)
3. **Several Small** patches (multiple small reserves)

## Loading Landscape Configurations

```{r load_landscapes}
print_separator()
cat("PART 1: TESTING SINGLE LARGE vs SEVERAL SMALL (SLOSS)\n")
print_separator()
cat("\nThe SLOSS debate: Which is better for conservation?\n")
cat("  • Single Large reserve\n")
cat("  • Several Small reserves with equivalent total area\n\n")

cat("STEP 1.1: Loading landscape configurations\n")
print_subseparator()

# Pristine landscape baseline (all cells = 1)
pristine_landscape <- create_fractal_landscape(
  cells_per_row = 15,
  fractality = 0.5,
  habitat_proportion = 1.0
)

# Single Large patch - from package dataset
single_large_patch <- single_large

# Several Small patches - from package dataset  
several_small_patches <- several_small

cat("✓ Pristine landscape:       ", nrow(pristine_landscape), "x", 
    ncol(pristine_landscape), "cells\n")
cat("✓ Single large patch:       ", nrow(single_large_patch), "x", 
    ncol(single_large_patch), "cells\n")
cat("✓ Several small patches:    ", nrow(several_small_patches), "x", 
    ncol(several_small_patches), "cells\n")

# Calculate habitat metrics
habitat_amount_pristine <- mean(pristine_landscape)
habitat_amount_single <- mean(single_large_patch)
habitat_amount_several <- mean(several_small_patches)

cat("\n")
print_subseparator()
cat("Habitat Quality Metrics:\n")
print_subseparator()
cat(sprintf("  Pristine (baseline):    %.1f%% (%.3f)\n", 
            habitat_amount_pristine * 100, habitat_amount_pristine))
cat(sprintf("  Single large:           %.1f%% (%.3f) [%.1f%% of pristine]\n", 
            habitat_amount_single * 100, habitat_amount_single,
            (habitat_amount_single / habitat_amount_pristine) * 100))
cat(sprintf("  Several small:          %.1f%% (%.3f) [%.1f%% of pristine]\n", 
            habitat_amount_several * 100, habitat_amount_several,
            (habitat_amount_several / habitat_amount_pristine) * 100))
cat("\n")
```

## Running Simulations

```{r run_sloss_sims}
cat("STEP 1.2: Running population simulations\n")
print_subseparator()
cat("Initial population size: 100 individuals per landscape\n")
cat("Maximum events: 300\n")
cat("Simulation mode: Deterministic with fixed seed\n\n")

# Baseline: Pristine landscape (control)
cat("  [1/3] Simulating pristine landscape...")
sim_pristine <- twolife_simulation(
  landscape_params = list(habitat = pristine_landscape),
  individual_params = list(initial_population_size = 100),
  simulation_params = list(max_events = 300),
  master_seed = MASTER_SEED
)
cat(" ✓ Complete\n")

# Treatment 1: Single large patch
cat("  [2/3] Simulating single large patch...")
sim_single_large <- twolife_simulation(
  landscape_params = list(habitat = single_large_patch),
  individual_params = list(initial_population_size = 100),
  simulation_params = list(max_events = 300),
  master_seed = MASTER_SEED
)
cat(" ✓ Complete\n")

# Treatment 2: Several small patches
cat("  [3/3] Simulating several small patches...")
sim_several_small <- twolife_simulation(
  landscape_params = list(habitat = several_small_patches),
  individual_params = list(initial_population_size = 100),
  simulation_params = list(max_events = 300),
  master_seed = MASTER_SEED
)
cat(" ✓ Complete\n\n")
```

## Analyzing Population Viability

```{r analyze_viability}
cat("STEP 1.3: Analyzing population viability\n")
print_subseparator()

# Compare final population sizes
final_population_sizes <- c(
  Pristine = sim_pristine$summary$final_population_size,
  Single_Large = sim_single_large$summary$final_population_size,
  Several_Small = sim_several_small$summary$final_population_size
)

cat("Final Population Sizes:\n")
cat(sprintf("  %-18s: %3d individuals\n", "Pristine", final_population_sizes["Pristine"]))
cat(sprintf("  %-18s: %3d individuals (%.1f%% of pristine)\n", 
            "Single Large", final_population_sizes["Single_Large"],
            (final_population_sizes["Single_Large"] / final_population_sizes["Pristine"]) * 100))
cat(sprintf("  %-18s: %3d individuals (%.1f%% of pristine)\n", 
            "Several Small", final_population_sizes["Several_Small"],
            (final_population_sizes["Several_Small"] / final_population_sizes["Pristine"]) * 100))

# Relative SLOSS comparison
sl_ss_diff <- final_population_sizes["Single_Large"] - final_population_sizes["Several_Small"]
sl_ss_pct <- abs(sl_ss_diff / max(final_population_sizes["Single_Large"], 
                                    final_population_sizes["Several_Small"]) * 100)

cat(sprintf("\nSLOSS Comparison (SL vs SS): %+d individuals (%.1f%% difference)\n", 
            sl_ss_diff, sl_ss_pct))

# Ecological interpretation
cat("\n")
print_subseparator()
cat("Ecological Interpretation:\n")
print_subseparator()

if (final_population_sizes["Pristine"] > final_population_sizes["Single_Large"]) {
  cat("✓ Habitat loss reduces carrying capacity\n")
  cat(sprintf("  → Pristine supports %d more individuals than single large (%.1f%% reduction)\n",
              final_population_sizes["Pristine"] - final_population_sizes["Single_Large"],
              (1 - final_population_sizes["Single_Large"] / 
                 final_population_sizes["Pristine"]) * 100))
} 

# SLOSS comparison
if (final_population_sizes["Single_Large"] > final_population_sizes["Several_Small"]) {
  cat("✓ Single large patch supports larger population (SL > SS)\n")
  cat(sprintf("  → Single large has %d more individuals (%.1f%% advantage)\n",
              sl_ss_diff, sl_ss_pct))
  cat("  → Evidence supports 'Single Large' hypothesis\n")
  cat("  → Interpretation: Lower edge effects and higher core habitat area\n")
} else if (final_population_sizes["Several_Small"] > final_population_sizes["Single_Large"]) {
  cat("✓ Several small patches support larger population (SS > SL)\n")
  cat(sprintf("  → Several small has %d more individuals (%.1f%% advantage)\n",
              -sl_ss_diff, sl_ss_pct))
  cat("  → Evidence supports 'Several Small' hypothesis\n")
  cat("  → Interpretation: Possible rescue effect or bet-hedging across patches\n")
} else {
  cat("◆ Single large and several small support equal populations\n")
  cat("  → No clear winner in this scenario\n")
}
cat("\n")

# Extract population trajectories
trajectory_pristine <- compute_population_size(sim_pristine)
trajectory_single_large <- compute_population_size(sim_single_large)
trajectory_several_small <- compute_population_size(sim_several_small)

print_subseparator()
cat("Population Dynamics Summary:\n")
print_subseparator()
cat(sprintf("  %-18s: %3d events, Duration = %.2f time units, Final N = %3d\n",
            "Pristine",
            nrow(trajectory_pristine),
            sim_pristine$summary$duration,
            tail(trajectory_pristine$population_size, 1)))
cat(sprintf("  %-18s: %3d events, Duration = %.2f time units, Final N = %3d\n",
            "Single Large",
            nrow(trajectory_single_large),
            sim_single_large$summary$duration,
            tail(trajectory_single_large$population_size, 1)))
cat(sprintf("  %-18s: %3d events, Duration = %.2f time units, Final N = %3d\n",
            "Several Small",
            nrow(trajectory_several_small),
            sim_several_small$summary$duration,
            tail(trajectory_several_small$population_size, 1)))
cat("\n")
```

## Visualizing Results

### Landscape Configurations and Survivors

```{r fig_landscapes, fig.width=7, fig.height=9}
cat("STEP 1.4: Creating visualizations\n")
print_subseparator()

# Plot landscape configurations
par(mfrow = c(2, 3), mar = c(4, 4, 3, 2))

plot_landscape_world_coords(pristine_landscape, 
                            main = "Pristine Landscape\n(Baseline Control)", 
                            colors = "habitat")
plot_landscape_world_coords(single_large_patch, 
                            main = "Single Large Patch\n(SLOSS: SL Strategy)", 
                            colors = "habitat")
plot_landscape_world_coords(several_small_patches, 
                            main = "Several Small Patches\n(SLOSS: SS Strategy)", 
                            colors = "habitat")

# Surviving individuals on landscapes
plot_simulation_on_landscape(sim_pristine, 
                             main = sprintf("Survivors: Pristine\n(N = %d)", 
                                            final_population_sizes["Pristine"]),
                             point_color = "darkgreen", point_size = 1.5)

plot_simulation_on_landscape(sim_single_large, 
                             main = sprintf("Survivors: Single Large\n(N = %d)", 
                                            final_population_sizes["Single_Large"]),
                             point_color = "blue", point_size = 1.5)

plot_simulation_on_landscape(sim_several_small, 
                             main = sprintf("Survivors: Several Small\n(N = %d)", 
                                            final_population_sizes["Several_Small"]),
                             point_color = "red", point_size = 1.5)

par(mfrow = c(1, 1), mar = c(5, 4, 4, 2))
```

### Population Trajectories

```{r fig_trajectories, fig.width=7, fig.height=5}
# Population trajectories through time
max_pop <- max(c(trajectory_pristine$population_size, 
                 trajectory_single_large$population_size, 
                 trajectory_several_small$population_size))

plot(trajectory_pristine$time, trajectory_pristine$population_size, 
     type = "l", col = "darkgreen", lwd = 2,
     main = "Population Trajectories: SLOSS Comparison\n(Starting N = 100)", 
     xlab = "Time (arbitrary units)", ylab = "Population Size (N)",
     ylim = c(0, max_pop * 1.05))

lines(trajectory_single_large$time, trajectory_single_large$population_size, 
      col = "blue", lwd = 2)
lines(trajectory_several_small$time, trajectory_several_small$population_size, 
      col = "red", lwd = 2)

legend("topright", 
       legend = c(
         sprintf("Pristine (N=%d)", final_population_sizes["Pristine"]),
         sprintf("Single Large (N=%d)", final_population_sizes["Single_Large"]),
         sprintf("Several Small (N=%d)", final_population_sizes["Several_Small"])
       ),
       col = c("darkgreen", "blue", "red"), 
       lwd = 2, bty = "n", cex = 0.9)

abline(h = 100, lty = 2, col = "gray50")
text(0, 100, "Initial N", pos = 3, cex = 0.8, col = "gray50")
```

### Final Comparison

```{r fig_barplot, fig.width=7, fig.height=5}
# Final comparison barplot
barplot(final_population_sizes, 
        main = "Final Population Sizes: SLOSS Comparison\n(Higher is better for conservation)",
        ylab = "Final Population Size (N)",
        col = c("darkgreen", "blue", "red"),
        las = 1,
        ylim = c(0, max(final_population_sizes) * 1.15))

# Add values on top of bars
text(x = seq(0.7, by = 1.2, length.out = 3), 
     y = final_population_sizes + max(final_population_sizes) * 0.05,
     labels = final_population_sizes,
     cex = 1.2, font = 2)

cat("✓ Visualizations complete\n\n")

print_separator()
cat("PART 1 COMPLETE: SLOSS Analysis Finished\n")
print_separator()
cat("\n\n")
```

# Part 2: Genetic and Evolutionary Features

## Creating Continuous Landscapes

```{r continuous_landscapes, fig.width=7, fig.height=3.5}
print_separator()
cat("PART 2: EXPLORING GENETIC AND EVOLUTIONARY FEATURES\n")
print_separator()
cat("\nInvestigating how genetic mechanisms enable population persistence\n")
cat("in heterogeneous environments\n\n")

cat("STEP 2.1: Creating continuous landscapes with varying fractality\n")
print_subseparator()
cat("Fractality controls spatial autocorrelation:\n")
cat("  • High fractality (0.9) → Smooth, predictable gradients\n")
cat("  • Medium fractality (0.5) → Moderate heterogeneity\n")
cat("  • Low fractality (0.1) → Rough, highly fragmented patterns\n\n")

# Create continuous landscapes with different fractality levels
continuous_smooth <- create_fractal_landscape(
  cells_per_row = 15,
  fractality = 0.9,
  habitat_proportion = NULL,
  min_value = 0.0,
  max_value = 1.0
)

continuous_medium <- create_fractal_landscape(
  cells_per_row = 15,
  fractality = 0.5,
  habitat_proportion = NULL,
  min_value = 0.0,
  max_value = 1.0
)

continuous_rough <- create_fractal_landscape(
  cells_per_row = 15,
  fractality = 0.1,
  habitat_proportion = NULL,
  min_value = 0.0,
  max_value = 1.0
)

cat("Landscape characteristics:\n")
cat(sprintf("  %-18s: Range [%.3f, %.3f], Mean = %.3f, SD = %.3f\n",
            "Smooth (f=0.9)",
            min(continuous_smooth), max(continuous_smooth),
            mean(continuous_smooth), sd(as.vector(continuous_smooth))))
cat(sprintf("  %-18s: Range [%.3f, %.3f], Mean = %.3f, SD = %.3f\n",
            "Medium (f=0.5)",
            min(continuous_medium), max(continuous_medium),
            mean(continuous_medium), sd(as.vector(continuous_medium))))
cat(sprintf("  %-18s: Range [%.3f, %.3f], Mean = %.3f, SD = %.3f\n",
            "Rough (f=0.1)",
            min(continuous_rough), max(continuous_rough),
            mean(continuous_rough), sd(as.vector(continuous_rough))))
cat("\n")

# Visualize the different fractality levels
par(mfrow = c(1, 3), mar = c(4, 4, 3, 2))
plot_landscape_world_coords(continuous_smooth, 
                            main = "Smooth Landscape\n(fractality = 0.9)", 
                            colors = "terrain")
plot_landscape_world_coords(continuous_medium, 
                            main = "Medium Landscape\n(fractality = 0.5)", 
                            colors = "terrain")
plot_landscape_world_coords(continuous_rough, 
                            main = "Rough Landscape\n(fractality = 0.1)", 
                            colors = "terrain")
par(mfrow = c(1, 1), mar = c(5, 4, 4, 2))
```

## Progressive Genetics Exploration

We will systematically test which genetic components enable population survival in heterogeneous environments.

```{r genetics_setup}
cat("\n")
print_separator()
cat("PROGRESSIVE GENETICS EXPLORATION\n")
print_separator()
cat("Systematic exploration: Which genetic components enable survival?\n\n")

# Use medium continuous landscape for genetics exploration
genetics_landscape <- continuous_medium

print_subseparator()
cat("Selected Genetics Test Landscape (Medium Fractality):\n")
print_subseparator()
cat(sprintf("  Value range:         [%.3f, %.3f]\n", 
            min(genetics_landscape), max(genetics_landscape)))
cat(sprintf("  Mean value:          %.3f\n", mean(genetics_landscape)))
cat(sprintf("  Standard deviation:  %.3f\n", sd(as.vector(genetics_landscape))))
cat(sprintf("  Coefficient of var:  %.2f%%\n", 
            (sd(as.vector(genetics_landscape)) / mean(genetics_landscape)) * 100))

cat("\n")
print_subseparator()
cat("Parameter Design Rationale:\n")
print_subseparator()
cat("  • Population size = 40:\n")
cat("      Balanced for computational speed and ecological realism\n")
cat("  • genotype_sds = 0.15:\n")
cat("      Moderate niche width (~±0.3 habitat tolerance range)\n")  
cat("  • mutation_rate = 0.05:\n")
cat("      5% mutation rate enables moderate evolutionary change\n")
cat("  • sampling_points = 20-100:\n")
cat("      Active habitat selection without excessive computation\n\n")
```

### Step 1: Default Genetics (Baseline)

```{r step1_default}
print_separator()
cat("STEP 1: DEFAULT GENETICS (Baseline)\n")
print_separator()
cat("Configuration:\n")
cat("  • All individuals identical\n")
cat("  • Specialized for habitat quality = 1.0\n")
cat("  • No genetic variation\n")
cat("  • No niche width (perfect specialists)\n\n")

cat("Expected outcome:\n")
cat("  Landscape range is [0, 1] with mean ~0.5\n")
cat("  Very few/no pixels have exactly value 1.0\n")
cat("  → PREDICTION: Rapid extinction due to habitat mismatch\n\n")

cat("Running simulation...")
result_no_genetics <- twolife_simulation(
  landscape_params = list(habitat = genetics_landscape),
  individual_params = list(initial_population_size = 40),
  simulation_params = list(max_events = 250),
  master_seed = MASTER_SEED
)
cat(" ✓\n\n")

print_subseparator()
cat(sprintf("RESULT: %d survivors after %.1f time units\n",
            result_no_genetics$summary$final_population_size,
            result_no_genetics$summary$duration))
print_subseparator()

if (result_no_genetics$summary$final_population_size == 0) {
  cat("✓ Prediction confirmed: Population extinct\n")
  cat("  Interpretation: No individual flexibility = no survival\n")
  cat("  Key insight: Genetic uniformity is fatal in variable environments\n")
} else {
  cat("✗ Unexpected survival detected!\n")
  cat(sprintf("  → %d individuals found exact habitat matches\n",
              result_no_genetics$summary$final_population_size))
  cat("  → Check: Landscape may have pixels at exactly 1.0\n")
}
cat("\n")
```

### Step 2: Variable Specialists

```{r step2_variable}
print_separator()
cat("STEP 2: VARIABLE SPECIALISTS\n")
print_separator()
cat("Configuration:\n")
cat("  • Different optimal habitat values per individual\n")
cat("  • Genotype range: [0.3, 0.7]\n")
cat("  • Still perfect specialists (genotype_sds = 0)\n")
cat("  • No within-individual flexibility\n\n")

cat("Expected outcome:\n")
cat("  Genotype diversity doesn't help without niche width\n")
cat("  Each individual still requires exact habitat match\n")
cat("  → PREDICTION: Extinction (no individual-level tolerance)\n\n")

cat("Running simulation...")
result_simple_genetics <- twolife_simulation(
  landscape_params = list(habitat = genetics_landscape),
  individual_params = list(initial_population_size = 40),
  genetic_params = list(
    genotype_means = runif(40, 0.3, 0.7)
  ),
  simulation_params = list(max_events = 250),
  master_seed = MASTER_SEED
)
cat(" ✓\n\n")

print_subseparator()
cat(sprintf("RESULT: %d survivors after %.1f time units\n",
            result_simple_genetics$summary$final_population_size,
            result_simple_genetics$summary$duration))
print_subseparator()

if (result_simple_genetics$summary$final_population_size == 0) {
  cat("✓ Prediction confirmed: Population extinct\n")
  cat("  Interpretation: Genotype diversity ≠ survival without niche width\n")
  cat("  Key insight: Having different optima doesn't create tolerance\n")
} else {
  cat("✗ Some individuals survived!\n")
  cat(sprintf("  → %d survivors found exact genotype-habitat matches\n",
              result_simple_genetics$summary$final_population_size))
  if (nrow(result_simple_genetics$survivors) > 0) {
    cat(sprintf("  → Survivor genotypes: %s\n", 
                paste(round(result_simple_genetics$survivors$genotype, 3), collapse = ", ")))
  }
}
cat("\n")
```

### Step 3: Generalists (Critical Innovation)

```{r step3_generalists}
print_separator()
cat("STEP 3: GENERALISTS (Critical Innovation)\n")
print_separator()
cat("Configuration:\n")
cat("  • Variable genotype means: [0.3, 0.7]\n")
cat("  • NEW: genotype_sds = 0.15 (creates niche width)\n")
cat("  • Creates niche width: each individual tolerates ~±0.3 range\n")
cat("  • No evolution yet (static genotypes)\n\n")

cat("Expected outcome:\n")
cat("  Niche width enables flexible habitat use\n")
cat("  Individuals can exploit suboptimal but acceptable habitats\n")
cat("  → PREDICTION: Population survival with spatial sorting\n\n")

cat("Running simulation...")
result_specialist_genetics <- twolife_simulation(
  landscape_params = list(habitat = genetics_landscape),
  individual_params = list(initial_population_size = 40),
  genetic_params = list(
    genotype_means = runif(40, 0.3, 0.7),
    genotype_sds = rep(0.15, 40)
  ),
  simulation_params = list(max_events = 250),
  master_seed = MASTER_SEED
)
cat(" ✓\n\n")

print_subseparator()
cat(sprintf("RESULT: %d survivors after %.1f time units\n",
            result_specialist_genetics$summary$final_population_size,
            result_specialist_genetics$summary$duration))
print_subseparator()

if (result_specialist_genetics$summary$final_population_size > 0) {
  cat("✓ Prediction confirmed: Population survived!\n")
  cat("  Interpretation: Niche width is the KEY to survival\n")
  cat(sprintf("  Mean survivor genotype: %.3f (range: [%.3f, %.3f])\n",
              mean(result_specialist_genetics$survivors$genotype),
              min(result_specialist_genetics$survivors$genotype),
              max(result_specialist_genetics$survivors$genotype)))
  cat(sprintf("  Mean survivor phenotype: %.3f (range: [%.3f, %.3f])\n",
              mean(result_specialist_genetics$survivors$phenotype),
              min(result_specialist_genetics$survivors$phenotype),
              max(result_specialist_genetics$survivors$phenotype)))
  cat(sprintf("  Survival rate: %.1f%% (%.1f-fold increase from Step 2)\n",
              (result_specialist_genetics$summary$final_population_size / 40) * 100,
              result_specialist_genetics$summary$final_population_size / 
                max(1, result_simple_genetics$summary$final_population_size)))
} else {
  cat("✗ Unexpected extinction!\n")
  cat("  → Environment may be too harsh for these parameters\n")
  cat("  → Consider: increasing genotype_sds or adjusting landscape\n")
}
cat("\n")
```

### Step 4: Evolution (Adding Adaptation)

```{r step4_evolution}
print_separator()
cat("STEP 4: EVOLUTION (Adding Adaptation)\n")
print_separator()
cat("Configuration:\n")
cat("  • Generalists (genotype_sds = 0.15)\n")
cat("  • NEW: mutation_rates = 0.05 (5% per reproduction)\n")
cat("  • NEW: plasticities = 0.02 (2% phenotypic adjustment)\n")
cat("  • Genotypes can now change over generational time\n\n")

cat("Expected outcome:\n")
cat("  Evolution allows tracking local optima\n")
cat("  Offspring can differ from parents\n")
cat("  → PREDICTION: Improved survival, local adaptation patterns\n\n")

cat("Running simulation...")
result_evolution <- twolife_simulation(
  landscape_params = list(habitat = genetics_landscape),
  individual_params = list(initial_population_size = 40),
  genetic_params = list(
    genotype_means = runif(40, 0.3, 0.7),
    genotype_sds = rep(0.15, 40),
    mutation_rates = rep(0.05, 40),
    plasticities = rep(0.02, 40)
  ),
  simulation_params = list(max_events = 250),
  master_seed = MASTER_SEED
)
cat(" ✓\n\n")

print_subseparator()
cat(sprintf("RESULT: %d survivors after %.1f time units\n",
            result_evolution$summary$final_population_size,
            result_evolution$summary$duration))
print_subseparator()

if (result_evolution$summary$final_population_size > 0) {
  cat("✓ Evolution enables enhanced persistence!\n")
  cat(sprintf("  Mean survivor genotype: %.3f (range: [%.3f, %.3f])\n",
              mean(result_evolution$survivors$genotype),
              min(result_evolution$survivors$genotype),
              max(result_evolution$survivors$genotype)))
  cat(sprintf("  Mean survivor phenotype: %.3f (range: [%.3f, %.3f])\n",
              mean(result_evolution$survivors$phenotype),
              min(result_evolution$survivors$phenotype),
              max(result_evolution$survivors$phenotype)))
  
  delta_survival <- result_evolution$summary$final_population_size - 
    result_specialist_genetics$summary$final_population_size
  if (delta_survival > 0) {
    cat(sprintf("  → Evolution improved survival by +%d individuals (%.1f%% gain)\n",
                delta_survival,
                (delta_survival / result_specialist_genetics$summary$final_population_size) * 100))
  } else if (delta_survival < 0) {
    cat(sprintf("  → Evolution reduced survival by %d individuals (stochastic variation)\n",
                delta_survival))
  } else {
    cat("  → Evolution produced equivalent survival (no net change)\n")
  }
} else {
  cat("✗ Population extinct despite evolutionary mechanisms\n")
  cat("  → Environmental stress exceeds adaptive capacity\n")
}
cat("\n")
```

### Step 5: Habitat Selection (Adding Behavior)

```{r step5_behavior}
print_separator()
cat("STEP 5: HABITAT SELECTION (Adding Behavior)\n")
print_separator()
cat("Configuration:\n")
cat("  • All previous mechanisms (niche width + evolution)\n")
cat("  • NEW: sampling_points = 100\n")
cat("  • Individuals sample 100 locations, choose best phenotype match\n")
cat("  • Active habitat selection behavior\n\n")

cat("Expected outcome:\n")
cat("  Behavioral optimization of habitat choice\n")
cat("  Maximizes benefit of phenotypic variation\n")
cat("  → PREDICTION: Highest survival, strong spatial genetic structure\n\n")

cat("Running simulation...")
result_habitat_selection <- twolife_simulation(
  landscape_params = list(habitat = genetics_landscape),
  individual_params = list(initial_population_size = 40),
  genetic_params = list(
    genotype_means = runif(40, 0.3, 0.7),
    genotype_sds = rep(0.15, 40),
    mutation_rates = rep(0.05, 40),
    plasticities = rep(0.02, 40),
    sampling_points = rep(100, 40)
  ),
  simulation_params = list(max_events = 250),
  master_seed = MASTER_SEED
)
cat(" ✓\n\n")

print_subseparator()
cat(sprintf("RESULT: %d survivors after %.1f time units\n",
            result_habitat_selection$summary$final_population_size,
            result_habitat_selection$summary$duration))
print_subseparator()

if (result_habitat_selection$summary$final_population_size > 0) {
  cat("✓ Habitat selection optimizes population outcomes!\n")
  cat(sprintf("  Mean survivor genotype: %.3f (range: [%.3f, %.3f])\n",
              mean(result_habitat_selection$survivors$genotype),
              min(result_habitat_selection$survivors$genotype),
              max(result_habitat_selection$survivors$genotype)))
  cat(sprintf("  Mean survivor phenotype: %.3f (range: [%.3f, %.3f])\n",
              mean(result_habitat_selection$survivors$phenotype),
              min(result_habitat_selection$survivors$phenotype),
              max(result_habitat_selection$survivors$phenotype)))
  
  delta_survival <- result_habitat_selection$summary$final_population_size - 
    result_evolution$summary$final_population_size
  if (delta_survival > 0) {
    cat(sprintf("  → Habitat selection improved survival by +%d individuals (%.1f%% gain)\n",
                delta_survival,
                (delta_survival / result_evolution$summary$final_population_size) * 100))
  } else if (delta_survival < 0) {
    cat(sprintf("  → Habitat selection reduced survival by %d (unexpected!)\n",
                delta_survival))
  } else {
    cat("  → Habitat selection produced equivalent survival\n")
  }
  
  total_improvement <- result_habitat_selection$summary$final_population_size - 
    result_simple_genetics$summary$final_population_size
  cat(sprintf("  → Overall improvement from Step 2: +%d individuals\n",
              total_improvement))
} else {
  cat("✗ Population extinct despite all mechanisms active\n")
  cat("  → Suggests parameter settings may need adjustment\n")
  cat("  → Or environmental conditions are extremely harsh\n")
}
cat("\n")
```

## Genetics Progression Summary

```{r genetics_summary, fig.width=7, fig.height=5}
print_separator()
cat("GENETICS PROGRESSION SUMMARY TABLE\n")
print_separator()

genetics_results <- data.frame(
  Step = 1:5,
  Scenario = c("Default", "Variable", "Generalists", "Evolution", "Habitat Selection"),
  Final_Pop = c(
    result_no_genetics$summary$final_population_size,
    result_simple_genetics$summary$final_population_size,
    result_specialist_genetics$summary$final_population_size,
    result_evolution$summary$final_population_size,
    result_habitat_selection$summary$final_population_size
  ),
  Survival_Rate = sprintf("%.1f%%", c(
    result_no_genetics$summary$final_population_size / 40 * 100,
    result_simple_genetics$summary$final_population_size / 40 * 100,
    result_specialist_genetics$summary$final_population_size / 40 * 100,
    result_evolution$summary$final_population_size / 40 * 100,
    result_habitat_selection$summary$final_population_size / 40 * 100
  )),
  Duration = sprintf("%.1f", c(
    result_no_genetics$summary$duration,
    result_simple_genetics$summary$duration,
    result_specialist_genetics$summary$duration,
    result_evolution$summary$duration,
    result_habitat_selection$summary$duration
  )),
  Key_Feature = c(
    "No flexibility",
    "Variable optima",
    "Niche width",
    "+ Evolution",
    "+ Behavior"
  ),
  Outcome = c(
    "Extinction",
    "Extinction", 
    "Survival",
    "Enhanced",
    "Optimized"
  )
)

print(genetics_results, row.names = FALSE)

cat("\n")
print_subseparator()
cat("Cumulative Improvement Analysis:\n")
print_subseparator()

breakthrough_step <- result_specialist_genetics$summary$final_population_size
if (breakthrough_step > 0) {
  cat(sprintf("  Step 3 (Generalists): Breakthrough from extinction to N=%d\n", 
              breakthrough_step))
  
  if (result_evolution$summary$final_population_size > breakthrough_step) {
    evolution_gain <- result_evolution$summary$final_population_size - breakthrough_step
    cat(sprintf("  Step 4 (Evolution):   +%d individuals (%.1f%% improvement)\n",
                evolution_gain, (evolution_gain / breakthrough_step) * 100))
  }
  
  if (result_habitat_selection$summary$final_population_size > breakthrough_step) {
    behavior_total <- result_habitat_selection$summary$final_population_size - breakthrough_step
    cat(sprintf("  Step 5 (Behavior):    +%d individuals from baseline (%.1f%% total gain)\n",
                behavior_total, (behavior_total / breakthrough_step) * 100))
  }
}
cat("\n")

# Visualize progression
barplot(genetics_results$Final_Pop,
        names.arg = genetics_results$Scenario,
        main = "Genetic Complexity vs. Survival Success\n(N = 40 initial population)",
        ylab = "Final Population Size",
        col = c("red", "orange", "yellow", "lightgreen", "darkgreen"),
        las = 2,
        ylim = c(0, max(genetics_results$Final_Pop) * 1.15))

text(x = seq(0.7, by = 1.2, length.out = 5), 
     y = genetics_results$Final_Pop + max(genetics_results$Final_Pop) * 0.05,
     labels = genetics_results$Final_Pop,
     cex = 1, font = 2)

abline(h = 40, lty = 2, col = "gray40")
text(0.5, 42, "Initial N = 40", pos = 4, cex = 0.8, col = "gray40")
```

## Spatial Genetics Analysis

```{r spatial_genetics, fig.width=7, fig.height=7}
cat("\n")
print_separator()
cat("SPATIAL GENETICS ANALYSIS\n")
print_separator()
cat("Visualizing spatial distribution of survivors and phenotypes\n")
cat("Note: Points colored by PHENOTYPE (expressed traits that determine fitness)\n\n")

par(mfrow = c(2, 2), mar = c(4, 4, 3, 2))

if (result_specialist_genetics$summary$final_population_size > 0) {
  plot_simulation_on_landscape(result_specialist_genetics,
                               main = sprintf("Generalists Only\n(N = %d survivors)",
                                              result_specialist_genetics$summary$final_population_size),
                               color_by = "phenotype",
                               landscape_colors = "terrain")
} else {
  plot(1, 1, type = "n", main = "Generalists Only\n(Population Extinct)", 
       xlab = "", ylab = "", axes = FALSE)
  text(1, 1, "No\nSurvivors", cex = 2, col = "red", font = 2)
  box()
}

if (result_evolution$summary$final_population_size > 0) {
  plot_simulation_on_landscape(result_evolution,
                               main = sprintf("With Evolution\n(N = %d survivors)",
                                              result_evolution$summary$final_population_size),
                               color_by = "phenotype",
                               landscape_colors = "terrain")
} else {
  plot(1, 1, type = "n", main = "With Evolution\n(Population Extinct)", 
       xlab = "", ylab = "", axes = FALSE)
  text(1, 1, "No\nSurvivors", cex = 2, col = "red", font = 2)
  box()
}

if (result_habitat_selection$summary$final_population_size > 0) {
  plot_simulation_on_landscape(result_habitat_selection,
                               main = sprintf("With Habitat Selection\n(N = %d survivors)",
                                              result_habitat_selection$summary$final_population_size),
                               color_by = "phenotype",
                               landscape_colors = "terrain")
} else {
  plot(1, 1, type = "n", main = "With Habitat Selection\n(Population Extinct)", 
       xlab = "", ylab = "", axes = FALSE)
  text(1, 1, "No\nSurvivors", cex = 2, col = "red", font = 2)
  box()
}

plot_landscape_world_coords(genetics_landscape, 
                            main = "Base Landscape\n(Continuous habitat quality)", 
                            colors = "terrain")

par(mfrow = c(1, 1), mar = c(5, 4, 4, 2))
```

## Habitat Matching Validation

```{r habitat_validation}
cat("\n")
print_separator()
cat("HABITAT MATCHING VALIDATION\n")
print_separator()
cat("Quantifying phenotype-environment correlation for survivors\n")
cat("Note: Fitness depends on PHENOTYPE matching habitat, not genotype\n\n")

print_subseparator()
cat("Generalists (Step 3):\n")
print_subseparator()
validate_habitat_matching(result_specialist_genetics, color_by = "phenotype")
calculate_genotype_habitat_mismatch(result_specialist_genetics)

cat("\n")
print_subseparator()
cat("Evolution (Step 4):\n")
print_subseparator()
validate_habitat_matching(result_evolution, color_by = "phenotype")
calculate_genotype_habitat_mismatch(result_evolution)

cat("\n")
print_subseparator()
cat("Habitat Selection (Step 5):\n")
print_subseparator()
validate_habitat_matching(result_habitat_selection, color_by = "phenotype")
calculate_genotype_habitat_mismatch(result_habitat_selection)
```

# Key Insights and Biological Lessons

```{r key_insights}
cat("\n\n")
print_separator()
cat("KEY ECOLOGICAL AND EVOLUTIONARY INSIGHTS\n")
print_separator()

cat("\n1. GENETIC DIVERSITY ALONE IS INSUFFICIENT\n")
cat("   └─ Steps 1-2 demonstrate extinction despite different genotypes\n")
cat("   └─ Implication: Conservation requires functional trait variation\n")

cat("\n2. NICHE WIDTH IS CRITICAL FOR SURVIVAL\n")
cat("   └─ Step 3 breakthrough: Tolerance ranges enable persistence\n")
cat("   └─ Implication: Specialists are vulnerable in variable environments\n")

cat("\n3. PHENOTYPIC PLASTICITY PROVIDES FLEXIBILITY\n")
cat("   └─ Phenotypes can differ from genotypes via plasticity\n")
cat("   └─ Implication: Immediate environmental responses complement evolution\n")

cat("\n4. EVOLUTION IMPROVES ADAPTIVE POTENTIAL\n")
cat("   └─ Step 4: Mutation and plasticity allow tracking conditions\n")
cat("   └─ Implication: Evolutionary capacity is a conservation asset\n")

cat("\n5. BEHAVIOR OPTIMIZES ECOLOGICAL OUTCOMES\n")
cat("   └─ Step 5: Active habitat selection maximizes fitness\n")
cat("   └─ Implication: Behavioral flexibility complements genetic adaptation\n")

cat("\n")
print_subseparator()
cat("CENTRAL LESSON:\n")
print_subseparator()
cat("Population persistence in heterogeneous environments requires\n")
cat("the integration of multiple mechanisms:\n")
cat("  • Genetic flexibility (niche width)\n")
cat("  • Phenotypic plasticity (immediate responses)\n")
cat("  • Evolutionary capacity (mutation, plasticity)\n")
cat("  • Behavioral adaptability (habitat selection)\n\n")

cat("Neither genetics nor behavior alone is sufficient—\n")
cat("their synergistic interaction determines survival outcomes.\n")
cat("Fitness depends on expressed PHENOTYPES matching the environment,\n")
cat("not just underlying genotypes.\n")

print_separator()
```

# Session Information

```{r session_info}
cat("\n\n")
print_separator()
cat("SESSION INFORMATION\n")
print_separator()
cat("\n")
sessionInfo()

cat("\n\n")
print_separator()
print_separator()
cat("              ✓ SIMULATION VIGNETTE COMPLETE ✓              \n")
print_separator()
print_separator()
cat("\nAll simulations executed successfully!\n")
cat(sprintf("Reproducibility: Results are fully reproducible using master seed %d\n", MASTER_SEED))
cat("Generated:", format(Sys.time(), "%Y-%m-%d at %H:%M:%S %Z"), "\n")
print_separator()
```

# Summary

This vignette demonstrated:

1. **SLOSS Analysis**: Comparing conservation strategies (Single Large vs Several Small reserves) using spatially explicit population models. Results showed habitat configuration significantly affects population viability.

2. **Genetic Mechanisms**: A progressive exploration revealing that:
   - Genetic diversity alone is insufficient (Steps 1-2)
   - Niche width enables survival (Step 3)
   - Evolution enhances adaptation (Step 4)
   - Behavior optimizes outcomes (Step 5)

3. **Key Finding**: Population persistence requires the synergistic integration of genetic flexibility (niche width), phenotypic plasticity (immediate environmental responses), evolutionary capacity (mutation), and behavioral adaptability (habitat selection). Fitness depends on expressed **phenotypes** matching the environment, not just underlying genotypes.

All results are reproducible using `master_seed = 42`, ensuring consistent outcomes across runs.